<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Sunday"><link rel="alternative" href="/atom.xml" title="I'm Sunday" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>自定义view流程 - I'm Sunday</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0;"><header class="head"><h1 class="head-title u-fl"><a href="/">I'm Sunday</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-03-06T07:25:13.000Z">March 6, 2018</time><h1 class="post__title"><a href="/2018/03/06/自定义view流程/">自定义view流程</a></h1><div class="post__main echo"><blockquote>
<p>什么某大厂的android面试题集锦，第一题是什么view的绘制流程，菜鸟表示很害怕，根本就不懂，学习学习。在此之前，先搬运一篇自定义TextView的小文章。</p>
</blockquote>
<p><strong>官方对view的介绍</strong></p>
<blockquote>
<p>View这个类代表用户界面组件的基本构建块。View在屏幕上占据一个矩形区域，并负责绘制和事件处理。View是用于创建交互式用户界面组件（按钮、文本等）的基础类。它的子类ViewGroup是所有布局的父类，它是一个可以包含其他view或者viewGroup并定义它们的布局属性的看不见的容器。<br>实现一个自定义View，你通常会覆盖一些framework层在所有view上调用的标准方法。你不需要重写所有这些方法。事实上，你可以只是重写onDraw(android.graphics.Canvas)。</p>
</blockquote>
<p>下面是view的实例方法:</p>
<p><img src="/2018/03/06/自定义view流程/classes.png" alt=""></p>
<p>从上面官方文档介绍我们可以知道，View是所有控件（包括ViewGroup）的父类，它里面有一些常见的方法（上表），如果我们要自定义View，最简单的只需要重写onDraw(android.graphics.Canvas)即可，听起来是不是很简单？那我们就动手自定义一个属于自己的TextView吧。 </p>
<h1 id="1-继承view，重写onDraw方法"><a href="#1-继承view，重写onDraw方法" class="headerlink" title="1.继承view，重写onDraw方法"></a>1.继承view，重写onDraw方法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.droodsunny.customtextview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Rect;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by DroodSunny on 2018/3/6.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">customText</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要绘制的文字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String mText;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本的颜色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextSize;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绘制时控制文本绘制的范围</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Rect mBound;</span><br><span class="line">    <span class="keyword">private</span> Paint mPaint;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">customText</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">customText</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">customText</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        mText = <span class="string">"我家曼曼最可爱"</span>;</span><br><span class="line">        mTextColor = Color.BLACK;</span><br><span class="line">        mTextSize = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        mPaint = <span class="keyword">new</span> Paint();</span><br><span class="line">        mPaint.setTextSize(mTextSize);</span><br><span class="line">        mPaint.setColor(mTextColor);</span><br><span class="line">        <span class="comment">//获得绘制文本的宽和高</span></span><br><span class="line">        mBound = <span class="keyword">new</span> Rect();</span><br><span class="line">        mPaint.getTextBounds(mText, <span class="number">0</span>, mText.length(), mBound);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//API21</span></span><br><span class="line"><span class="comment">//    public MyTextView(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) &#123;</span></span><br><span class="line"><span class="comment">//        super(context, attrs, defStyleAttr, defStyleRes);</span></span><br><span class="line"><span class="comment">//        init();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String text)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mText=text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> color)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mTextColor=color;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mTextSize=size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//绘制文字</span></span><br><span class="line">        <span class="comment">//getWidth()获得view的宽度</span></span><br><span class="line">        <span class="comment">//mBound.with()获得字体的总宽度</span></span><br><span class="line">        <span class="comment">//从下往上画</span></span><br><span class="line">        Log.d(<span class="string">"textwidth"</span>,<span class="string">""</span>+mBound.width());</span><br><span class="line"></span><br><span class="line">        canvas.drawText(mText, getWidth() / <span class="number">2</span> - mBound.width() / <span class="number">2</span>, getHeight() / <span class="number">2</span> + mBound.height() / <span class="number">2</span>, mPaint);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>drawText的基线是字体的左下角的坐标，而不是左上角。</p>
<p>运行结果：</p>
<p><img src="/2018/03/06/自定义view流程/result.png" alt=""></p>
<p>当然这样写存在问题，因为这样写在xml中无法指定TextView的属性<br>所以我们要自定义属性</p>
<h1 id="2-自定义属性"><a href="#2-自定义属性" class="headerlink" title="2 自定义属性"></a>2 自定义属性</h1><p>在values文件夹下新建类型为values的attrs.xml文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;resources&gt;</span><br><span class="line">&lt;attr name=<span class="string">"mText"</span> format=<span class="string">"string"</span>/&gt;</span><br><span class="line">&lt;attr name=<span class="string">"mTextColor"</span> format=<span class="string">"color"</span>/&gt;</span><br><span class="line">&lt;attr name=<span class="string">"mTextSize"</span> format=<span class="string">"dimension"</span>/&gt;</span><br><span class="line">&lt;declare-styleable name=<span class="string">"customText"</span>&gt;</span><br><span class="line">    &lt;attr name=<span class="string">"mText"</span>/&gt;</span><br><span class="line">    &lt;attr name=<span class="string">"mTextColor"</span>/&gt;</span><br><span class="line">    &lt;attr name=<span class="string">"mTextSize"</span>/&gt;</span><br><span class="line">&lt;/declare-styleable&gt;</span><br><span class="line"></span><br><span class="line">&lt;/resources&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后在layout资源文件里加入我们自定义的属性</p>
<p><strong>必须引入我们的命名空间</strong> ：xmlns:app=”<a href="http://schemas.android.com/apk/res-auto" target="_blank" rel="noopener">http://schemas.android.com/apk/res-auto</a>“<br>不过在Androidstudio3.0中新建layout资源文件时一般都会自动引入这句话。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">LinearLayout xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    xmlns:app=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">    xmlns:tools=<span class="string">"http://schemas.android.com/tools"</span></span><br><span class="line">    android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">    android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">    tools:context=<span class="string">"com.example.droodsunny.customtextview.MainActivity"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;com.example.droodsunny.customtextview.customText</span><br><span class="line">        android:id=<span class="string">"@+id/mText"</span></span><br><span class="line">        app:mText=<span class="string">"思念会有声音"</span></span><br><span class="line">        android:layout_width=<span class="string">"200dp"</span></span><br><span class="line">        android:layout_height=<span class="string">"200dp"</span></span><br><span class="line">        android:background=<span class="string">"#ff0000"</span></span><br><span class="line">         /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们在资源文件中定义的属性必须要view得到，所以在view的构造方法中得到属性的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取自定义属性的值</span></span><br><span class="line"></span><br><span class="line">       TypedArray array=context.getTheme().obtainStyledAttributes(attrs,R.styleable.customText,defStyleAttr,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">       mText = array.getString(R.styleable.customText_mText);</span><br><span class="line">       mTextColor=array.getColor(R.styleable.customText_mTextColor, Color.BLACK);</span><br><span class="line">       mTextSize=array.getDimension(R.styleable.customText_mTextSize,<span class="number">100</span>);</span><br><span class="line">       <span class="comment">//注意回收</span></span><br><span class="line">       array.recycle();</span><br></pre></td></tr></table></figure>
<p>运行结果：<br><img src="/2018/03/06/自定义view流程/result1.png" alt=""></p>
<p>这样写还是存在问题，如果我们这样设置属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:layout_width="wrap_content"</span><br><span class="line">android:layout_height="wrap_content"</span><br></pre></td></tr></table></figure></p>
<p>会出现这样的结果：<br><img src="/2018/03/06/自定义view流程/result2.png" alt=""><br>这显然不是我们想要的，这是我们没有重写onMeasure()方法</p>
<h1 id="3-重写onMeasure方法"><a href="#3-重写onMeasure方法" class="headerlink" title="3 重写onMeasure方法"></a>3 重写onMeasure方法</h1><ol>
<li>MeasureSpec</li>
</ol>
<p>在学习onMasure方法之前，我们要先了解他的参数中的一个类MeasureSpec，知己知彼才能百战百胜 。<br>跟踪一下源码，发现它是View中的一个静态内部类，是由尺寸和模式组合而成的一个值，用来描述父控件对子控件尺寸的约束，看看他的部分源码，一共有三种模式，然后提供了合成和分解的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * measurespec封装了父控件对他的孩子的布局要求。</span></span><br><span class="line"><span class="comment"> * 一个measurespec由大小和模式。有三种可能的模式：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MeasureSpec</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_SHIFT = <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_MASK  = <span class="number">0x3</span> &lt;&lt; MODE_SHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//父控件不强加任何约束给子控件，它可以是它想要任何大小。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNSPECIFIED = <span class="number">0</span> &lt;&lt; MODE_SHIFT;  <span class="comment">//0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//父控件决定给孩子一个精确的尺寸</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXACTLY     = <span class="number">1</span> &lt;&lt; MODE_SHIFT;  <span class="comment">//1073741824</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//父控件会给子控件尽可能大的尺寸</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AT_MOST     = <span class="number">2</span> &lt;&lt; MODE_SHIFT;   <span class="comment">//-2147483648</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据给定的尺寸和模式创建一个约束规范</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">makeMeasureSpec</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sUseZeroUnspecifiedMeasureSpec &amp;&amp; mode == UNSPECIFIED) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> makeMeasureSpec(size, mode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从约束规范中获取模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMode</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (measureSpec &amp; MODE_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从约束规范中获取尺寸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (measureSpec &amp; ~MODE_MASK);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>分析为什么我们自定义的MyTextView设置了wrap_content却填充屏幕</li>
</ol>
<p>上面三种约束模式与布局参数的对应关系见下图<br><img src="/2018/03/06/自定义view流程/onMeasure.pag" alt=""></p>
<p>下面我们来看一下onMeasure的源码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = size;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        result = size;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        result = specSize;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>onMeasure方法调用了setMeasuredDimension(int measuredWidth, int measuredHeight)方法，而传入的参数已经是测量过的默认宽和高的值了；我们看看getDefaultSize 方法是怎么计算测量宽高的。根据父控件给予的约束，发现AT_MOST （相当于wrap_content ）和EXACTLY （相当于match_parent ）两种情况返回的测量宽高都是specSize，而这个specSize正是我们上面说的父控件剩余的宽高，所以默认onMeasure方法中wrap_content 和match_parent 的效果是一样的，都是填充剩余的空间。</p>
<ol>
<li>重写onMeasure方法</li>
</ol>
<p>我们先忽略掉UNSPECIFIED 的情况（使用极少），只考虑AT_MOST 和EXACTLY ，现在的问题是设置wrap_content 时，控件却使用了match_parent 的效果，看下面怎么重写onMeasure（注释比较详细，不做过多讲解）： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> widthMode=MeasureSpec.getMode(widthMeasureSpec);<span class="comment">//获取宽的模式</span></span><br><span class="line">        <span class="keyword">int</span> heightMode=MeasureSpec.getMode(heightMeasureSpec);<span class="comment">//获取高的模式</span></span><br><span class="line">        <span class="keyword">int</span> widthSize=MeasureSpec.getSize(widthMeasureSpec);<span class="comment">//获取宽的尺寸</span></span><br><span class="line">        <span class="keyword">int</span> heightSize=MeasureSpec.getSize(heightMeasureSpec);<span class="comment">//获取高的尺寸</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> width;</span><br><span class="line">        <span class="keyword">int</span> height;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理view的宽</span></span><br><span class="line">        <span class="comment">//如果属性是match_parent或者是具体的值，则直接赋值</span></span><br><span class="line">        <span class="keyword">if</span>(widthMode==MeasureSpec.EXACTLY)&#123;</span><br><span class="line">            width=widthSize;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//得到控件需要多大的尺寸</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取字体的宽度</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> textWidth=mBound.width();</span><br><span class="line">            <span class="comment">//控件的宽度就是文本的宽度加上两边的内边距。内边距就是padding值，在构造方法执行完就被赋值</span></span><br><span class="line">            width=(<span class="keyword">int</span>)(textWidth+getPaddingLeft()+getPaddingRight());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理view的高度</span></span><br><span class="line">        <span class="keyword">if</span>(heightMode==MeasureSpec.EXACTLY)&#123;</span><br><span class="line">            height=heightSize;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//得到控件需要多大的尺寸</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取字体的高度</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> textHeight=mBound.height();</span><br><span class="line">            <span class="comment">//控件的宽度就是文本的宽度加上两边的内边距。内边距就是padding值，在构造方法执行完就被赋值</span></span><br><span class="line">            height=(<span class="keyword">int</span>)(textHeight+getPaddingTop()+getPaddingBottom());</span><br><span class="line">        &#125;</span><br><span class="line">        setMeasuredDimension(width,height);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>给加上padding属性<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.example.droodsunny.customtextview.customText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/mText"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:mText</span>=<span class="string">"思念会有声音"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:padding</span>=<span class="string">"20dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"#ff0000"</span></span></span><br><span class="line"><span class="tag">         /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>运行结果如下<br><img src="/2018/03/06/自定义view流程/result3.png" alt=""></p>
<h1 id="4-进阶训练-实现自动换行"><a href="#4-进阶训练-实现自动换行" class="headerlink" title="4 进阶训练 实现自动换行"></a>4 进阶训练 实现自动换行</h1><p>只需要在测量的时候，根据文字的总长度和控件的宽度，就可以知道需要绘制几行，然后将文本分割成小段放入集合中，在onDraw方法中分别绘制；<br>需要注意的是，onMeasure方法不只调用一次，所以在分段文本是需要判断，不要重复分段，否则会报错。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.droodsunny.customtextview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.TypedArray;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Rect;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by DroodSunny on 2018/3/6.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">customText</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要绘制的文字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;String&gt; textList;</span><br><span class="line">    <span class="keyword">private</span> String mText;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本的颜色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextColor;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mTextSize;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绘制时控制文本绘制的范围</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Rect mBound;</span><br><span class="line">    <span class="keyword">private</span> Paint mPaint;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">customText</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">customText</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">customText</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line"></span><br><span class="line">        textList=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取自定义属性的值</span></span><br><span class="line"></span><br><span class="line">        TypedArray array=context.getTheme().obtainStyledAttributes(attrs,R.styleable.customText,defStyleAttr,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        mText = array.getString(R.styleable.customText_mText);</span><br><span class="line">        mTextColor=array.getColor(R.styleable.customText_mTextColor, Color.BLACK);</span><br><span class="line">        mTextSize=array.getDimension(R.styleable.customText_mTextSize,<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//注意回收</span></span><br><span class="line">        array.recycle();</span><br><span class="line">        <span class="comment">//初始化画笔</span></span><br><span class="line">        mPaint = <span class="keyword">new</span> Paint();</span><br><span class="line">        mPaint.setTextSize(mTextSize);</span><br><span class="line">        mPaint.setColor(mTextColor);</span><br><span class="line">        <span class="comment">//获得绘制文本的宽和高</span></span><br><span class="line">        mBound = <span class="keyword">new</span> Rect();</span><br><span class="line">        mPaint.getTextBounds(mText, <span class="number">0</span>, mText.length(), mBound);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//API21</span></span><br><span class="line"><span class="comment">//    public MyTextView(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) &#123;</span></span><br><span class="line"><span class="comment">//        super(context, attrs, defStyleAttr, defStyleRes);</span></span><br><span class="line"><span class="comment">//        init();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String text)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mText=text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> color)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mTextColor=color;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTextSize</span><span class="params">(<span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mTextSize=size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getTextSize</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTextSize;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//绘制文字</span></span><br><span class="line">        <span class="comment">//getWidth()获得view的宽度</span></span><br><span class="line">        <span class="comment">//mBound.with()获得字体的总宽度</span></span><br><span class="line">        <span class="comment">//从下往上画</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//绘制多行</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;textList.size();i++)&#123;</span><br><span class="line">            canvas.drawText(textList.get(i), getPaddingStart(), (getPaddingTop()+mBound.height())*(i+<span class="number">1</span>), mPaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> isOneLines = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">int</span> spLineNum;<span class="comment">//最大行数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> fontScale=getResources().getDisplayMetrics().scaledDensity;</span><br><span class="line">        <span class="keyword">int</span> widthMode=MeasureSpec.getMode(widthMeasureSpec);<span class="comment">//获取宽的模式</span></span><br><span class="line">        <span class="keyword">int</span> heightMode=MeasureSpec.getMode(heightMeasureSpec);<span class="comment">//获取高的模式</span></span><br><span class="line">        <span class="keyword">int</span> widthSize=MeasureSpec.getSize(widthMeasureSpec);<span class="comment">//获取宽的尺寸</span></span><br><span class="line">        <span class="keyword">int</span> heightSize=MeasureSpec.getSize(heightMeasureSpec);<span class="comment">//获取高的尺寸</span></span><br><span class="line">        Log.d(<span class="string">"widthSize"</span>,widthSize+<span class="string">""</span>);</span><br><span class="line">        <span class="comment">//获取字体的宽度</span></span><br><span class="line">        <span class="keyword">float</span> textWidth=mBound.width();</span><br><span class="line">        <span class="comment">//mText的长度，即字符串的长度</span></span><br><span class="line">        <span class="comment">//判断是否已经对文本分过段</span></span><br><span class="line">        <span class="keyword">if</span>(textList.size()==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> padding=getPaddingLeft()+getPaddingRight();<span class="comment">//内边距宽度</span></span><br><span class="line">            <span class="keyword">int</span> specWidth=widthSize-padding;<span class="comment">//能够显示文本的最大宽度</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(textWidth&lt;specWidth)&#123;</span><br><span class="line">                spLineNum=<span class="number">1</span>;</span><br><span class="line">                textList.add(mText);</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                isOneLines=<span class="keyword">false</span>;</span><br><span class="line">               <span class="comment">/* spLineNum=((int)(textWidth/specWidth))+1;*/</span></span><br><span class="line">               spLineNum= (<span class="keyword">int</span>) (textWidth/specWidth)+<span class="number">1</span>;</span><br><span class="line">                Log.d(<span class="string">"lineStr"</span>,mTextSize/fontScale+<span class="number">0.5f</span>+<span class="string">""</span>);</span><br><span class="line">                Log.d(<span class="string">"lineStr"</span>,specWidth+<span class="string">""</span>);</span><br><span class="line">                Log.d(<span class="string">"lineStr"</span>,spLineNum+<span class="string">""</span>);</span><br><span class="line">                <span class="comment">//每一行字符串的长度</span></span><br><span class="line">                <span class="keyword">int</span> lineLength= (<span class="keyword">int</span>) (specWidth/mTextSize);</span><br><span class="line">                String lineStr;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;spLineNum;i++)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(mText.length()&lt;lineLength)&#123;</span><br><span class="line">                        lineStr=mText.substring(<span class="number">0</span>,mText.length());</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((mText.length()-i*lineLength)&lt;lineLength)&#123;</span><br><span class="line">                        lineStr=mText.substring(i*lineLength,mText.length());</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        lineStr=mText.substring(i*lineLength,(i+<span class="number">1</span>)*lineLength);</span><br><span class="line">                    &#125;</span><br><span class="line">                    textList.add(lineStr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> width;</span><br><span class="line">        <span class="keyword">int</span> height;</span><br><span class="line">        <span class="comment">//处理view的宽</span></span><br><span class="line">        <span class="comment">//如果属性是match_parent或者是具体的值，则直接赋值</span></span><br><span class="line">        <span class="keyword">if</span>(widthMode==MeasureSpec.EXACTLY)&#123;</span><br><span class="line">            width=widthSize;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//控件的宽度就是文本的宽度加上两边的内边距。内边距就是padding值，在构造方法执行完就被赋值</span></span><br><span class="line">            width=(<span class="keyword">int</span>)(textWidth+getPaddingLeft()+getPaddingRight());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理view的高度</span></span><br><span class="line">        <span class="keyword">if</span>(heightMode==MeasureSpec.EXACTLY)&#123;</span><br><span class="line">            height=heightSize;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//获取字体的高度</span></span><br><span class="line">            <span class="keyword">float</span> textHeight=mBound.height();</span><br><span class="line">            <span class="comment">//如果是一行</span></span><br><span class="line">            <span class="keyword">if</span>(isOneLines) &#123;</span><br><span class="line">                <span class="comment">//控件的宽度就是文本的宽度加上两边的内边距。内边距就是padding值，在构造方法执行完就被赋值</span></span><br><span class="line">                height = (<span class="keyword">int</span>) (textHeight + getPaddingTop() + getPaddingBottom());</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                height=(<span class="keyword">int</span>)(spLineNum*textHeight+getPaddingTop()*spLineNum+getPaddingBottom());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        setMeasuredDimension(width,height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="/2018/03/06/自定义view流程/result4.png" alt=""></p>
<p>到此为止，我们已经了解到自定义控件的基本步骤： </p>
<ol>
<li>继承View，重写构造方法 </li>
<li>自定义属性，在构造方法中初始化属性 </li>
<li>重写onMeasure方法测量宽高 </li>
<li>重写onDraw方法绘制控件</li>
</ol>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/Android/">Android</a></li></ul></footer></article><section class="reward"> <a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechatss.png" title="微信"></div></section><div class="comments" id="lv-container" data-id="city" data-uid="your uid"><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2016-2019 Sunday</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>